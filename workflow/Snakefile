import re
import subprocess as sp

IN_GENOMES = config["genomes"]
IN_GENES = config["genes"]

RESULTS = config["results"]
RESULTS_GENOMES = f"{RESULTS}/genomes"

GENOME_REGEX = r"GC[AF]_\d+\.\d"


configfile: "config/config.yaml"


wildcard_constraints:
    genome=GENOME_REGEX,


def fasta_entries(path):
    CP = sp.run(f"grep -c '^>' {path}", shell=True, capture_output=True, check=True)
    return int(CP.stdout)


assert fasta_entries(IN_GENES) == 2, "Pipeline is only valid for 2 genes"


def parse_genomes(path):
    with open(path, "r") as file:
        genomes = list()
        for line in file:
            line = re.sub(r"#.*$", "", line)  # rm comments
            line = line.strip()  # rm leading and trailing whitespace
            if re.match(GENOME_REGEX, line).group(0) == line:
                genomes.append(line)  # append only valid assembly ids
    return genomes


GENOMES = parse_genomes(IN_GENOMES)

print(GENOMES)


rule help:
    shell:
        "bat workflow/Snakefile"


rule download_genome:
    output:
        faa=f"{RESULTS_GENOMES}/{{genome}}/{{genome}}.faa",
        gff=f"{RESULTS_GENOMES}/{{genome}}/{{genome}}.gff",
    conda:
        "envs/ncbi_datasets.yaml"
    shell:
        """
        mkdir -p {RESULTS_GENOMES}/{wildcards.genome}
        workflow/scripts/download_genome.py --include protein gff3 --out-dir {RESULTS_GENOMES}/{wildcards.genome} -- {wildcards.genome}
        """


rule blastp:
    input:
        faa=rules.download_genome.output.faa,
        queries=f"{IN_GENES}",
    output:
        tsv=f"{RESULTS_GENOMES}/{{genome}}/{{genome}}.tsv",
    params:
        db=f"{RESULTS_GENOMES}/{{genome}}/{{genome}}",
        format="6 qseqid sseqid pident qcovhsp scovhsp evalue",
    shell:
        """
        diamond makedb --in {input.faa} -d {params.db}
        diamond blastp --header --outfmt {params.format}\
            -o {output.tsv}\
            -d {params.db}\
            -q {input.queries}
        """
